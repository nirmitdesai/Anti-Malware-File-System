#include<stdio.h>
#include<fcntl.h>
#include<stdlib.h>
#include<string.h>
#include "pattern_ioctl.h"

/**
 * get_pattern_list
 * @fd: file descriptor to determine where our ioctl call will go
 * @user_args: structure which contains the arguments passed by user
 *
 * Retrieves the list of patterns which are currently in pattern.db
 *
 * Returns 0 on success; non-zero otherwise
 */
int get_pattern_list(int fd, struct user_args_t *user_args)
{
	puts("Get pattern!");
	int i, err = 0;
	int count_and_max_len;
	int count, max_len;

	err = ioctl(fd, IOCTL_GET_COUNT, &count_and_max_len);
	count = count_and_max_len / 100;
	max_len = count_and_max_len % 100;
	if (count == 0) {
		fprintf(stderr, "No patterns to display\n");
		return err;
	}
	char *patterns[count];

	for (i = 0 ; i < count ; i++) {
		patterns[i] = malloc(sizeof(char) * max_len + 1);
		if (!patterns[i]) {
			printf("error in allocating memory for %d pattern\n",
			       i + 1);
			return 1;
		}
		memset(patterns[i], 0, sizeof(char) * max_len + 1);
	}

	err = ioctl(fd, IOCTL_GET_LIST, patterns);
	if (err) {
		printf("error in get list ioctl");
		return err;
	}
	for (i = 0 ; i < count ; i++) {
		printf("pattern = %s\n", patterns[i]);
		free(patterns[i]);
	}
	return err;
}

/**
 * add_pattern
 * @fd: file descriptor to determine where our ioctl call will go
 * @user_args: structure which contains the arguments passed by user
 *
 * Makes ioctl call to add the pattern to pattern.db file
 *
 * Returns 0 on success; non-zero otherwise
 */
int add_pattern(int fd, struct user_args_t *user_args)
{
	int err = 0;

	err = ioctl(fd, IOCTL_ADD_PATTERN, user_args);
	if (err < 0)
		perror("Error ");
	return err;
}

/**
 * remove_pattern
 * @fd: file descriptor to determine where our ioctl call will go
 * @user_args: structure which contains the arguments passed by user
 *
 * Makes ioctl call to remove the pattern from pattern.db file
 *
 * Returns 0 on success; non-zero otherwise
 */
int remove_pattern(int fd, struct user_args_t *user_args)
{
	int err = 0;

	err = ioctl(fd, IOCTL_REMOVE_PATTERN, user_args);
	if (err < 0)
		perror("Error: ");
	return err;
}

/**
 * do_ioctl
 * @operation: flag to determine which ioctl will be invoked
 * @user_args: structure which contains the arguments passed by user
 *
 * Calls appropriate function as per the operation selected by user
 * (list pattern/add pattern/remove pattern)
 *
 * Returns 0 on success; non-zero otherwise
 */
int do_ioctl(int operation, struct user_args_t *user_args)
{
	puts("in ioctl!");
	char *pattern_file = "/mnt/amfs/";
	int fd, err = 0;

	fd = open(pattern_file, O_RDONLY);
	if (fd < 0) {
		perror("open:");
		return fd;
	}
	switch (operation) {
	case 0:
		err = get_pattern_list(fd, user_args);
		break;
	case 1:
		err = add_pattern(fd, user_args);
		break;
	case 2:
		err = remove_pattern(fd, user_args);
		break;
	default:
		break;
	}
	return err;
}
